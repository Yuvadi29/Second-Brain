{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///Users/adityatrivedi/Desktop/Dev/Second-Brain/second-brain/lib/chromaClient.ts"],"sourcesContent":["\nimport { CloudClient } from \"chromadb\";\nimport dotenv from \"dotenv\";\n\ndotenv.config();\n\nconst apiKey = process.env.CHROMA_API_KEY!;\nconst tenant = process.env.CHROMA_TENANT!;\nconst database = process.env.CHROMA_DATABASE!;\n\nif (!apiKey || !tenant || !database) {\n  throw new Error(\"CHROMA_API_KEY, CHROMA_TENANT, CHROMA_DATABASE must be set\");\n}\n\nexport const chroma = new CloudClient({\n  apiKey,\n  tenant,\n  database,\n})\n\nexport async function getOrCreateCollection(name: string) {\n  return chroma.getOrCreateCollection({\n    name,\n  });\n}\n"],"names":[],"mappings":";;;;;;AACA;AACA;;;;;;;AAEA,kJAAM,CAAC,MAAM;AAEb,MAAM,SAAS,QAAQ,GAAG,CAAC,cAAc;AACzC,MAAM,SAAS,QAAQ,GAAG,CAAC,aAAa;AACxC,MAAM,WAAW,QAAQ,GAAG,CAAC,eAAe;AAE5C,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,UAAU;IACnC,MAAM,IAAI,MAAM;AAClB;AAEO,MAAM,SAAS,IAAI,+HAAW,CAAC;IACpC;IACA;IACA;AACF;AAEO,eAAe,sBAAsB,IAAY;IACtD,OAAO,OAAO,qBAAqB,CAAC;QAClC;IACF;AACF"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///Users/adityatrivedi/Desktop/Dev/Second-Brain/second-brain/app/api/chat/route.ts"],"sourcesContent":["import { getOrCreateCollection } from \"@/lib/chromaClient\";\nimport { google } from \"@ai-sdk/google\";\nimport { convertToModelMessages, generateText, streamText, type UIMessage } from 'ai';\nimport { NextRequest } from \"next/server\";\n\nexport const runtime = \"nodejs\";\nexport const maxDuration = 40; //Allow streaming for upto 40s\n\nfunction extractUserMessageText(msg: any): string {\n    if (Array.isArray(msg.parts)) {\n        return msg.parts\n            .map((p: any) => (p.type === \"text\" ? p.text : \"\"))\n            .join(\"\\n\")\n            .trim();\n    }\n    return \"\";\n}\n\n\nconst COLLECTION_NAME = \"secondbrain\";\n\nexport async function POST(req: NextRequest) {\n    const { messages } = (await req.json() as { messages: UIMessage[] });\n\n    if (!messages || !messages?.length) {\n        return new Response(\"Missing messages\", { status: 400 });\n    };\n\n    // Get last user message as query\n    const lastUserIndex = [...messages].reverse().findIndex((m) => m?.role === \"user\");\n\n    if (lastUserIndex === -1) {\n        return new Response(\"No user message found\", { status: 400 });\n    }\n\n    const realIndex = messages?.length - 1 - lastUserIndex;\n    const lastUserMessage = messages[realIndex];\n    const query = extractUserMessageText(lastUserMessage);\n\n    if (!query?.trim()) {\n        return new Response(\"Empty user query\", { status: 400 });\n    }\n\n    // RAG: Retrieve Top-k chunks from Chroma\n    const collection = await getOrCreateCollection(COLLECTION_NAME);\n\n    const ragResults = await collection?.query({\n        queryTexts: [query],\n        nResults: 5,\n        include: [\"documents\", \"metadatas\"],\n    });\n\n    const docs = (ragResults?.documents?.[0] ?? []) as string[];\n    const metas = (ragResults?.metadatas?.[0] ?? []) as Record<string, any>[];\n\n    // Build a context block\n    const context = docs\n        ?.map((doc, i) => {\n            const meta = metas[i] || {};\n            const source = meta?.filePath ?? meta?.path ?? \"unknown\";\n            const chunkIndex = meta?.chunkIndex ?? i;\n            return `Source ${i + 1} (file: ${source}, chunk: ${chunkIndex}):\\n${doc}`;\n        }).join(\"\\n\\n\");\n\n    const systemPrompt = `\nYou are Adi's personal Second Brain assistant.\n\nUse ONLY the information provided in the \"Context\" section below when answering.\nIf the answer is not clearly contained in the context, say:\n\"I don't have that in my Second Brain yet.\"\n\nWhen you answer:\n- Be concise but clear.\n- Prefer bullet points where it helps.\n- If relevant, mention which source(s) you used.\n`.trim();\n\n    const augmentedLastUser: UIMessage = {\n        // ...lastUserMessage,\n        // content: `${query}\n        id: lastUserMessage?.id,\n        role: \"user\",\n        parts: [\n            {\n                type: \"text\",\n                text: `${query} \n                --- \n                Context from Adi's Second Brain:\n                ${context || \"[no matching context found]\"}\n                \n                Now answer the user's question strictly based on the context above.\n                `\n            }\n        ],\n    }\n\n    // Build model messages: system + previous history + augmented last user\n    const uiMessagesWithContext: UIMessage[] = [\n        {\n            id: \"system-1\",\n            role: \"system\",\n            parts: [{\n                type: \"text\",\n                text: systemPrompt\n            }],\n        },\n        ...messages?.slice(0, realIndex),\n        augmentedLastUser,\n    ];\n\n    // Stream response\n    const result = streamText({\n        model: google(\"gemini-2.5-flash\"),\n        messages: convertToModelMessages(uiMessagesWithContext),\n    });\n\n    // Return streaming response compatible with useChat\n    return result?.toUIMessageStreamResponse();\n}"],"names":[],"mappings":";;;;;;;;AAAA;AACA;AACA;;;;;;;;AAGO,MAAM,UAAU;AAChB,MAAM,cAAc,IAAI,8BAA8B;AAE7D,SAAS,uBAAuB,GAAQ;IACpC,IAAI,MAAM,OAAO,CAAC,IAAI,KAAK,GAAG;QAC1B,OAAO,IAAI,KAAK,CACX,GAAG,CAAC,CAAC,IAAY,EAAE,IAAI,KAAK,SAAS,EAAE,IAAI,GAAG,IAC9C,IAAI,CAAC,MACL,IAAI;IACb;IACA,OAAO;AACX;AAGA,MAAM,kBAAkB;AAEjB,eAAe,KAAK,GAAgB;IACvC,MAAM,EAAE,QAAQ,EAAE,GAAI,MAAM,IAAI,IAAI;IAEpC,IAAI,CAAC,YAAY,CAAC,UAAU,QAAQ;QAChC,OAAO,IAAI,SAAS,oBAAoB;YAAE,QAAQ;QAAI;IAC1D;;IAEA,iCAAiC;IACjC,MAAM,gBAAgB;WAAI;KAAS,CAAC,OAAO,GAAG,SAAS,CAAC,CAAC,IAAM,GAAG,SAAS;IAE3E,IAAI,kBAAkB,CAAC,GAAG;QACtB,OAAO,IAAI,SAAS,yBAAyB;YAAE,QAAQ;QAAI;IAC/D;IAEA,MAAM,YAAY,UAAU,SAAS,IAAI;IACzC,MAAM,kBAAkB,QAAQ,CAAC,UAAU;IAC3C,MAAM,QAAQ,uBAAuB;IAErC,IAAI,CAAC,OAAO,QAAQ;QAChB,OAAO,IAAI,SAAS,oBAAoB;YAAE,QAAQ;QAAI;IAC1D;IAEA,yCAAyC;IACzC,MAAM,aAAa,MAAM,IAAA,8IAAqB,EAAC;IAE/C,MAAM,aAAa,MAAM,YAAY,MAAM;QACvC,YAAY;YAAC;SAAM;QACnB,UAAU;QACV,SAAS;YAAC;YAAa;SAAY;IACvC;IAEA,MAAM,OAAQ,YAAY,WAAW,CAAC,EAAE,IAAI,EAAE;IAC9C,MAAM,QAAS,YAAY,WAAW,CAAC,EAAE,IAAI,EAAE;IAE/C,wBAAwB;IACxB,MAAM,UAAU,MACV,IAAI,CAAC,KAAK;QACR,MAAM,OAAO,KAAK,CAAC,EAAE,IAAI,CAAC;QAC1B,MAAM,SAAS,MAAM,YAAY,MAAM,QAAQ;QAC/C,MAAM,aAAa,MAAM,cAAc;QACvC,OAAO,CAAC,OAAO,EAAE,IAAI,EAAE,QAAQ,EAAE,OAAO,SAAS,EAAE,WAAW,IAAI,EAAE,KAAK;IAC7E,GAAG,KAAK;IAEZ,MAAM,eAAe,CAAC;;;;;;;;;;;AAW1B,CAAC,CAAC,IAAI;IAEF,MAAM,oBAA+B;QACjC,sBAAsB;QACtB,qBAAqB;QACrB,IAAI,iBAAiB;QACrB,MAAM;QACN,OAAO;YACH;gBACI,MAAM;gBACN,MAAM,GAAG,MAAM;;;gBAGf,EAAE,WAAW,8BAA8B;;;gBAG3C,CAAC;YACL;SACH;IACL;IAEA,wEAAwE;IACxE,MAAM,wBAAqC;QACvC;YACI,IAAI;YACJ,MAAM;YACN,OAAO;gBAAC;oBACJ,MAAM;oBACN,MAAM;gBACV;aAAE;QACN;WACG,UAAU,MAAM,GAAG;QACtB;KACH;IAED,kBAAkB;IAClB,MAAM,SAAS,IAAA,oKAAU,EAAC;QACtB,OAAO,IAAA,mKAAM,EAAC;QACd,UAAU,IAAA,gLAAsB,EAAC;IACrC;IAEA,oDAAoD;IACpD,OAAO,QAAQ;AACnB"}}]
}