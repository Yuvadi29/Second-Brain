{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///Users/adityatrivedi/Desktop/Dev/Second-Brain/second-brain/lib/chromaClient.ts"],"sourcesContent":["\nimport { CloudClient } from \"chromadb\";\nimport dotenv from \"dotenv\";\n\ndotenv.config();\n\nconst apiKey = process.env.CHROMA_API_KEY!;\nconst tenant = process.env.CHROMA_TENANT!;\nconst database = process.env.CHROMA_DATABASE!;\n\nif (!apiKey || !tenant || !database) {\n  throw new Error(\"CHROMA_API_KEY, CHROMA_TENANT, CHROMA_DATABASE must be set\");\n}\n\nexport const chroma = new CloudClient({\n  apiKey,\n  tenant,\n  database,\n})\n\nexport async function getOrCreateCollection(name: string) {\n  return chroma.getOrCreateCollection({\n    name,\n  });\n}\n"],"names":[],"mappings":";;;;;;AACA;AACA;;;;;;;AAEA,kJAAM,CAAC,MAAM;AAEb,MAAM,SAAS,QAAQ,GAAG,CAAC,cAAc;AACzC,MAAM,SAAS,QAAQ,GAAG,CAAC,aAAa;AACxC,MAAM,WAAW,QAAQ,GAAG,CAAC,eAAe;AAE5C,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,UAAU;IACnC,MAAM,IAAI,MAAM;AAClB;AAEO,MAAM,SAAS,IAAI,+HAAW,CAAC;IACpC;IACA;IACA;AACF;AAEO,eAAe,sBAAsB,IAAY;IACtD,OAAO,OAAO,qBAAqB,CAAC;QAClC;IACF;AACF"}},
    {"offset": {"line": 114, "column": 0}, "map": {"version":3,"sources":["file:///Users/adityatrivedi/Desktop/Dev/Second-Brain/second-brain/lib/chunkAndIngest.ts"],"sourcesContent":["\"use server\";\n\nimport { RecursiveCharacterTextSplitter } from \"@langchain/textsplitters\";\nimport { getOrCreateCollection } from \"./chromaClient\";\n\nexport async function ingestTextIntoChroma(\n    collectionName: string,\n    filePath: string,\n    text: string,\n    metadata: Record<string, any> = {}\n) {\n    const splitter = new RecursiveCharacterTextSplitter({\n        chunkSize: 1200,\n        chunkOverlap: 200,\n    });\n\n    const chunks = await splitter.splitText(text);\n    const collection = await getOrCreateCollection(collectionName);\n\n    await collection?.add({\n        ids: chunks?.map((_, i) => `${filePath}::${i}`),\n        documents: chunks,\n        metadatas: chunks?.map((_, i) => ({\n            ...metadata,\n            filePath,\n            chunkIndex: i\n        })),\n    });\n\n    console.log(`Ingested ${chunks?.length} chunks from ${filePath}`);\n\n\n}"],"names":[],"mappings":";;;;;AAEA;AAAA;AACA;;;;;;;;;AAEO,eAAe,qBAClB,cAAsB,EACtB,QAAgB,EAChB,IAAY,EACZ,WAAgC,CAAC,CAAC;IAElC,MAAM,WAAW,IAAI,yMAA8B,CAAC;QAChD,WAAW;QACX,cAAc;IAClB;IAEA,MAAM,SAAS,MAAM,SAAS,SAAS,CAAC;IACxC,MAAM,aAAa,MAAM,IAAA,8IAAqB,EAAC;IAE/C,MAAM,YAAY,IAAI;QAClB,KAAK,QAAQ,IAAI,CAAC,GAAG,IAAM,GAAG,SAAS,EAAE,EAAE,GAAG;QAC9C,WAAW;QACX,WAAW,QAAQ,IAAI,CAAC,GAAG,IAAM,CAAC;gBAC9B,GAAG,QAAQ;gBACX;gBACA,YAAY;YAChB,CAAC;IACL;IAEA,QAAQ,GAAG,CAAC,CAAC,SAAS,EAAE,QAAQ,OAAO,aAAa,EAAE,UAAU;AAGpE;;;IA3BsB;;AAAA,iPAAA"}},
    {"offset": {"line": 160, "column": 0}, "map": {"version":3,"sources":["file:///Users/adityatrivedi/Desktop/Dev/Second-Brain/second-brain/app/api/github/webhook/route.ts"],"sourcesContent":["// import { getOrCreateCollection } from \"@/lib/chromaClient\";\n// import { ingestTextIntoChroma } from \"@/lib/chunkAndIngest\";\n// import crypto from \"crypto\";\n\n// export const runtime = \"nodejs\";\n\n// const GH_SECRET = process.env.GITHUB_WEBHOOK_SECRET!;\n// const OWNER = process.env.GITHUB_REPO_OWNER!;\n// const REPO = process.env.GITHUB_REPO_NAME!;\n// const GITHUB_TOKEN = process.env.GITHUB_ACCESS_TOKEN!;\n\n// function verifySignature(payload: string, signature: string | null) {\n//     if (!signature) return false;\n//     const hmac = crypto.createHmac(\"sha256\", GH_SECRET);\n//     const digest = `sha256=${hmac.update(payload).digest('hex')}`;\n//     return crypto?.timingSafeEqual(Buffer?.from(digest), Buffer?.from(signature));\n// };\n\n// async function fetchFileContent(path: string, ref: string): Promise<string | null> {\n//     const encodedPath = path.split('/').map(s => encodeURIComponent(s)).join('/');\n//     const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodedPath}?ref=${ref}`;\n//     console.log(`Fetching from: ${url}`);\n\n//     const res = await fetch(url, {\n//         headers: {\n//             // Authorization: `Bearer ${GITHUB_TOKEN}`,\n//             Accept: \"application/vnd.github.v3.raw\",\n//         }\n//     });\n\n//     if (res.status === 404) {\n//         console.error(`File not found (404): ${path}`);\n//         return null;\n//     }\n//     if (!res.ok) {\n//         console.error(\"GitHub fetch error: \", res.status, await res.text());\n//         return null;\n//     }\n\n//     return await res.text();\n// }\n\n// export async function POST(req: Request) {\n//     console.log(\"Webhook received\");\n//     const rawBody = await req.text();\n//     const signature = req.headers.get(\"x-hub-signature-256\");\n\n//     if (!verifySignature(rawBody, signature)) {\n//         console.error(\"Invalid signature\");\n//         return new Response(\"Invalid signature\", { status: 401 });\n//     }\n//     console.log(\"Signature verified\");\n\n//     const event = req.headers.get(\"x-github-event\");\n//     console.log(`Event: ${event}`);\n//     if (event !== \"push\") {\n//         console.log(\"Ignored event (not push)\");\n//         return new Response(\"Ignored\", { status: 204 });\n//     }\n\n//     const payload = JSON.parse(rawBody);\n//     console.log(`Payload received for ref: ${payload?.ref}, after: ${payload?.after}`);\n\n//     const afterSha = payload?.after as string;\n//     const commits = payload?.commits ?? [];\n//     // const touchedFiles: string[] = [];\n\n//     const touchedFiles: string[] = [];\n\n//     for (const c of commits) {\n//         const added = c.added ?? [];\n//         const modified = c.modified ?? [];\n\n//         for (const f of [...added, ...modified]) {\n//             console.log(\"Checking file:\", f);\n\n//             if (typeof f === \"string\" && f.includes(\"knowledge/\")) {\n//                 touchedFiles.push(f);\n//             }\n//         }\n//     }\n\n\n\n\n//     console.log(`Touched knowledge files: ${touchedFiles.join(\", \")}`);\n\n//     if (touchedFiles?.length === 0) {\n//         console.log(\"No knowledge files changed\");\n//         return new Response(\"No knowledge files changed\", { status: 200 });\n//     }\n\n//     for (const path of touchedFiles) {\n//         console.log(`Fetching content for: ${path}`);\n//         const content = await fetchFileContent(path, afterSha);\n//         if (!content) {\n//             console.log(`Content is empty or failed to fetch for ${path}, skipping ingestion`);\n//             continue;\n//         }\n//         console.log(`Content fetched for ${path}, length: ${content.length}`);\n\n//         try {\n//             await ingestTextIntoChroma(\n//                 \"secondbrain\",\n//                 path,\n//                 content,\n//                 { ref: afterSha }\n//             )\n//             console.log(`Successfully ingested ${path}`);\n//         } catch (error) {\n//             console.error(`Error ingesting ${path}:`, error);\n//         }\n//     }\n\n//     return new Response(\"OK\", { status: 200 });\n// }\n\nimport crypto from \"crypto\";\nimport { NextRequest } from \"next/server\";\nimport { getOrCreateCollection } from \"@/lib/chromaClient\";\nimport { ingestTextIntoChroma } from \"@/lib/chunkAndIngest\";\n\nexport const runtime = \"nodejs\";\n\nconst GH_SECRET = process.env.GITHUB_WEBHOOK_SECRET!;\nconst OWNER = process.env.GITHUB_REPO_OWNER!;\nconst REPO = process.env.GITHUB_REPO_NAME!;\nconst GITHUB_TOKEN = process.env.GITHUB_ACCESS_TOKEN!;\n\nfunction verifySignature(payload: string, signature: string | null) {\n    if (!signature) return false;\n    const hmac = crypto.createHmac(\"sha256\", GH_SECRET);\n    const digest = `sha256=${hmac.update(payload).digest(\"hex\")}`;\n    return crypto.timingSafeEqual(Buffer.from(digest), Buffer.from(signature));\n}\n\nasync function fetchFileContent(path: string, ref: string): Promise<string | null> {\n    const res = await fetch(\n        `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(\n            path,\n        )}?ref=${ref}`,\n        {\n            headers: {\n                Authorization: `Bearer ${GITHUB_TOKEN}`,\n                Accept: \"application/vnd.github.v3.raw\",\n            },\n        },\n    );\n\n    if (res.status === 404) return null;\n    if (!res.ok) {\n        console.error(\"GitHub fetch error:\", res.status, await res.text());\n        return null;\n    }\n\n    return await res.text();\n}\n\nexport async function POST(req: NextRequest) {\n    const rawBody = await req.text();\n    const signature = req.headers.get(\"x-hub-signature-256\");\n\n    if (!verifySignature(rawBody, signature)) {\n        return new Response(\"Invalid signature\", { status: 401 });\n    }\n\n    const event = req.headers.get(\"x-github-event\");\n    if (event !== \"push\") {\n        return new Response(\"Ignored\", { status: 204 });\n    }\n\n    const payload = JSON.parse(rawBody);\n\n    const afterSha = payload.after as string;\n    const commits = payload.commits ?? [];\n    const touchedFiles: string[] = [];\n\n    for (const c of commits) {\n        for (const f of [...c.added, ...c.modified]) {\n            if (typeof f === \"string\" && f.startsWith(\"knowledge/\")) {\n                touchedFiles.push(f);\n            }\n        }\n    }\n\n    if (touchedFiles.length === 0) {\n        return new Response(\"No knowledge files changed\", { status: 200 });\n    }\n\n    const collection = await getOrCreateCollection(\"secondbrain\");\n\n    for (const path of touchedFiles) {\n        const content = await fetchFileContent(path, afterSha);\n        if (!content) continue;\n\n        await ingestTextIntoChroma(\n            \"secondbrain\",\n            path,\n            content,\n            { ref: afterSha }\n        );\n    }\n\n    return new Response(\"OK\", { status: 200 });\n}\n"],"names":[],"mappings":"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"}}]
}